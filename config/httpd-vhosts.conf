##########################
# Settings for HTTP site #
##########################

<Virtualhost *:80>
        ####################
        # General Settings #
        ####################
        ServerAdmin webmaster@localhost
        ServerName www.timo.be
        ServerAlias timoverbrugghe.duckdns.org

        ######################
        # Directory Settings #
        ######################
        # DocumentRoot /home/fileserver/Media/Network
        # <Directory "/home/fileserver/Media/Network">
        #        Options Indexes FollowSymLinks
        #        AllowOverride All
        #        Require all granted
        # </Directory>

        ########################
        # Redirection Settings #
        ########################
        # RedirectMatch 301 ^/((?!wiiu).*)$ https://www.timo.be/$1
        Redirect permanent / https://www.timo.be/

</Virtualhost>

###########################
# Settings for HTTPS site #
###########################

<IfModule mod_ssl.c>

<VirtualHost *:443>
        ####################
        # General Settings #
        ####################
        ServerAdmin webmaster@localhost
        ServerName www.timo.be
        ServerAlias timoverbrugghe.duckdns.org
        Protocols h2 http/1.1

        LimitRequestFieldSize 131072

        ############################
        # Set up 404 & Redirection #
        ############################
        ErrorDocument 404 https://www.timo.be/
        RedirectMatch ^/$ /muximux/

        ######################
        # Directory Settings #
        ######################
        DocumentRoot /home/fileserver/Media/Network
        <Directory /home/fileserver/Media/Network/>
                Options Indexes FollowSymLinks
                AllowOverride All
        </Directory>

        <Location /vnc>
                DirectoryIndex vnc.html
        </Location>

        ################
        # SSL Settings #
        ################
        SSLEngine on
        SSLCertificateFile /etc/letsencrypt/live/timoverbrugghe.duckdns.org/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/timoverbrugghe.duckdns.org/privkey.pem

        Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains;"

        #############################
        # GZip Compression settings #
        #############################

        <IfModule mod_deflate.c>
        SetOutputFilter DEFLATE
        AddOutputFilterByType DEFLATE text/css application/x-javascript text/x-component text/html text/plain text/xml application/javascript
                <IfModule mod_setenvif.c>
                BrowserMatch ^Mozilla/4 gzip-only-text/html
                BrowserMatch ^Mozilla/4.0[678] no-gzip
                BrowserMatch bMSIE !no-gzip !gzip-only-text/html
                </IfModule>
        </IfModule>

        Header append Vary User-Agent env=!dont-vary

        #############################
        # Password & Login settings #
        #############################

        ###########################
        # Google Sign-in Settings #
        ###########################
        OIDCProviderMetadataURL https://accounts.google.com/.well-known/openid-configuration
        OIDCClientID 897570863362-f22310kn8goknpdec66cnktid713kek8.apps.googleusercontent.com
        OIDCClientSecret MpmNdBxUKhf0PsuqCxXhbp1F
        OIDCSessionType server-cache
        OIDCRemoteUserClaim email
        OIDCScope "openid email"
        OIDCHTTPTimeoutShort 30

        OIDCRedirectURI https://www.timo.be/oauth2callback
        OIDCCryptoPassphrase eipvnjoiazvnioaruzevnopurzavVNZIODFVNIVNOIVHNZEv

        # Google Login (manually set entries since a default "/" location does not work) #
        <LocationMatch /(backup.log|muximux|scanner|shell|netdata|oauth2callback|jackett|admin|generatedata)>
                AuthType openid-connect
                Require claim email:verbrugghet@gmail.com email:nancyverbrugghe@gmail.com
        </LocationMatch>

        # Disable login for NextCloud, Wiiu, robots.txt, Google Webmaster Console & Let's Encrypt authentication folder
        <LocationMatch /(nextcloud|wiiu|robots.txt|google7394dc9b8b893c9f.html|.well-known|vnc)>
                AllowOverride All
                Satisfy Any
                Require all granted
        </LocationMatch>

        # Set up normal password login for specific applications #
        <LocationMatch /(nzbget|sonarr|radarr|deluge|alltube)>
                AuthType Basic
                AuthName "Welcome to Timo's Fileserver. Please fill in your password."
                AuthUserFile /etc/httpd/.htpasswd
                Require user fileserver
        </LocationMatch>

        # Temporary test location #
        <LocationMatch /(test)>
                AuthType Basic
                AuthName "Welcome to this Test Page. Please fill in your password."
                AuthUserFile /etc/httpd/.htpasswd
                Require user test
        </LocationMatch>

        ###############################################################################################
        # Proxy settings, in order to forward web apps to Apache to enable SSL & Auth support for all #
        ###############################################################################################
        # General Proxy Settings #
        ProxyPreserveHost On
        ProxyRequests Off
        AllowEncodedSlashes NoDecode

        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"

        <Proxy *>
                Order deny,allow
                Allow from all
        </Proxy>

        # Proxy Settings for each web app #
        ProxyPass /sonarr http://localhost:8081/sonarr retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /sonarr http://localhost:8081/sonarr

        ProxyPass /radarr http://localhost:8082/radarr retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /radarr http://localhost:8082/radarr

        ProxyPass /deluge/ http://localhost:8083/ retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon

        <Location /deluge/>
                ProxyPassReverse /
                ProxyPassReverseCookiePath / /deluge/
                RequestHeader set X-Deluge-Base "/deluge/"
                Order allow,deny
                Allow from all
        </Location>

        ProxyPass /shell http://localhost:8085/ retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /shell http://localhost:8085/

        # VNC Proxy
        ProxyPass /websockify ws://localhost:8086/websockify retry=3 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /websockify ws://localhost:8086/websockify

        ProxyPass /netdata http://localhost:8087/ retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /netdata http://localhost:8087/

        ProxyPass /jackett http://localhost:8088/jackett retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /jackett http://localhost:8088/jackett

        ProxyPass /bazarr http://localhost:8089/bazarr retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /bazarr http://localhost:8089/bazarr
        
        # AllowEncodedSlashes NoDecode is required for Sonarr/Radarr config testing
        AllowEncodedSlashes NoDecode

        ProxyPass /lidarr http://localhost:8090/lidarr retry=1 acquire=3000 timeout=600 KeepAlive=On nocanon
        ProxyPassReverse /lidarr http://localhost:8090/lidarr

</VirtualHost>
</IfModule>
